//======================================================================================================================
/*
  Kyosu - Complex Without Complexes
  Copyright : KYOSU Contributors & Maintainers
  SPDX-License-Identifier: BSL-1.0
*/
//======================================================================================================================
#include <kyosu/kyosu.hpp>
#include <test.hpp>

TTS_CASE_WITH ( "Check kyosu::bessel_kr over real positive order"
              , kyosu::scalar_real_types
              , tts::generate(tts::randoms(-10,10))
              )
  <typename T>(T )
{
  if constexpr(sizeof(T) == 8)
  {
    auto constexpr N = 11;
    using a_t  = std::array<T, 16 >;
    using aN_t = std::array<a_t, N >;
    a_t re{-5.2999999999999998e+00, -4.5999999999999996e+00, -3.8999999999999999e+00, -3.2000000000000002e+00, -2.5000000000000000e+00, -1.7999999999999998e+00, -1.1000000000000005e+00, -4.0000000000000036e-01, 2.9999999999999982e-01, 1.0000000000000000e+00, 1.7000000000000002e+00, 2.3999999999999995e+00, 3.0999999999999988e+00, 3.7999999999999998e+00, 4.4999999999999991e+00, 5.2000000000000002e+00};
    a_t im{8.0000000000000000e+00, -7.0000000000000000e+00, 6.0000000000000000e+00, -5.0000000000000000e+00, 4.0000000000000000e+00, -3.0000000000000000e+00, 2.0000000000000000e+00, -1.0000000000000000e+00, -0.0000000000000000e+00, 1.0000000000000000e+00, -2.0000000000000000e+00, 3.0000000000000000e+00, -4.0000000000000000e+00, 5.0000000000000000e+00, -6.0000000000000000e+00, 7.0000000000000000e+00};
    aN_t reresN16;
    aN_t imresN16;
    //res are taken from octave 9.2.0 besselk outputs
    int i=0;
    reresN16[i] = a_t{-7.6339268874816966e+01,-9.2192136865580512e+00,1.6508508118018792e+01,1.2375096096000567e+01,2.3503760861380147e+00,-2.5566294609268230e+00,-2.4913144969412047e+00,-6.0742679340229055e-01,1.5091129245821360e+00,7.5263258886450732e-02,-1.0402938701852732e-01,-5.4882419994366216e-02,-6.5488350696814700e-03,7.4931851019796377e-03,4.9792792996237569e-03,8.9451308743070568e-04,};
    imresN16[i] = a_t{-2.8143596488672866e+01,4.2273285530950140e+01,-1.6385214857913763e+01,-2.8174548075889092e+00,6.6761389661094128e+00,-3.1878291715173703e+00,-3.3868350891838195e-01,1.6945714309783351e+00,0.0000000000000000e+00,-3.6796936276059572e-01,9.2097126162947351e-02,1.6635565810036414e-02,-2.4007330768135104e-02,8.2054910688589972e-03,8.7325515356663085e-04,-2.1515168333318974e-03,};
    ++i; //1 1.333e+00
    reresN16[i] = a_t{-7.4763937634035742e+01,-1.2273432325692831e+01,1.3853377430820347e+01,1.1791391852785866e+01,3.1529916836233478e+00,-1.5893762392499222e+00,-2.1926880381374709e+00,-1.6847708495721365e+00,5.3402033678005392e+00,-3.8886701239423727e-02,-1.4693756835768643e-01,-5.9583284091062026e-02,-4.1438235363865372e-03,8.9507556227038949e-03,5.2356684403569772e-03,7.8238887432207857e-04,};
    imresN16[i] = a_t{-2.1224833898614598e+01,3.9210733545992341e+01,-1.6989871261677663e+01,-1.1228136733862792e+00,5.7065742243698079e+00,-3.3440837353861270e+00,5.3256175384783178e-01,8.5356937530213151e-01,0.0000000000000000e+00,-5.4882955826364632e-01,8.6677273663298901e-02,2.7971006868986542e-02,-2.7273162269682346e-02,8.0866505605811621e-03,1.3687066990329313e-03,-2.3423904910746017e-03,};
    ++i; //2 2.333e+00
    reresN16[i] = a_t{-6.9781909819647041e+01,-1.7505695865340261e+01,8.3867923307238357e+00,9.9446469426155257e+00,4.1413954345629884e+00,2.5233098282224198e-01,-7.1161886052565348e-01,-1.0204406680535001e+00,4.8977587305031470e+01,-7.0835842045097719e-01,-2.6780235790760909e-01,-6.5557553004590069e-02,3.4729580961059756e-03,1.2526729670551687e-02,5.7069008836194363e-03,4.6216831131121064e-04,};
    imresN16[i] = a_t{-7.5665343180441793e+00,3.2152289689391246e+01,-1.7263156232092197e+01,1.9158000557304615e+00,3.4547574175949043e+00,-2.9152317846011520e+00,1.6060679419030250e+00,-2.9633563844078492e+00,0.0000000000000000e+00,-1.0478931721262268e+00,3.5387393608418152e-02,6.1058378593912450e-02,-3.4536769495878070e-02,7.2572486088650131e-03,2.6545027168396432e-03,-2.7707401429528855e-03,};
    ++i; //3 3.333e+00
    reresN16[i] = a_t{-5.9089539889087455e+01,-2.1887445893881896e+01,1.4337719842717176e+00,6.3087377955563220e+00,3.8798467424339877e+00,1.5718708791086984e+00,1.3856122066085177e+00,1.1878866254683462e+01,7.6721378366829049e+02,-4.1368070839195656e+00,-5.0322896357959290e-01,-5.1414401525793345e-02,2.2991221018346924e-02,1.8876629702266952e-02,6.0448923067480571e-03,-2.6042491204442402e-04,};
    imresN16[i] = a_t{9.0969916568181119e+00,2.1222489290955579e+01,-1.5440188423095151e+01,4.6499582097613015e+00,4.2066180562300826e-01,-1.0548206022029860e+00,2.2494062713072921e-01,1.5169677660880414e+00,0.0000000000000000e+00,-1.3410773121725641e+00,-2.3534720884916846e-01,1.3648452870611938e-01,-4.4251037354143805e-02,3.9387005018675092e-03,5.2004894864991864e-03,-3.4251643684876680e-03,};
    ++i; //4 4.333e+00
    reresN16[i] = a_t{-4.1841815370976732e+01,-2.2054838199512837e+01,-4.4014445080746469e+00,1.7271380522283286e+00,1.7393071548347689e+00,4.3484417683820259e-01,-2.0862729526662931e+00,-3.7046384736797222e+01,1.7098172779933688e+04,-1.8967973074091368e+01,-6.4012439021237055e-01,6.3647064184413543e-02,6.8103163633903882e-02,2.7980532134708545e-02,5.2327175901523120e-03,-1.7586242647053304e-03,};
    imresN16[i] = a_t{2.3164436350617841e+01,8.3176667327617366e+00,-1.0543882269397290e+01,5.0682447599577483e+00,-1.5103486449649364e+00,6.8732252982775432e-01,-2.2565796627813484e+00,6.1818707685984272e+01,0.0000000000000000e+00,8.2712060670304268e+00,-1.3255687575311765e+00,2.7867629795798954e-01,-4.6306477090426568e-02,-6.1667011213983759e-03,9.7266871944378212e-03,-4.1724480450942934e-03,};
    ++i; //5 5.333e+00
    reresN16[i] = a_t{-2.0779173511814896e+01,-1.6547540424007785e+01,-6.3676936208002637e+00,-1.2827274403489390e+00,-1.6706298251902277e-01,-4.4234112531920666e-01,-2.3043900978300029e+00,-3.3927170804787369e+02,4.9471442742619739e+05,-5.0489464114516963e+01,1.4627157555415677e+00,5.2917114603135640e-01,1.5711836674653926e-01,3.5465587014026717e-02,6.8112789617335960e-04,-4.6315959833898631e-03,};
    imresN16[i] = a_t{2.9045007250433034e+01,-2.5744201234764050e+00,-4.0115937125794092e+00,2.7851264159776963e+00,-8.1851845175667126e-01,-1.0071312939938140e+00,1.1294958022792523e+01,-4.6001192967384424e+02,0.0000000000000000e+00,1.1669536563268852e+02,-4.6802725776890934e+00,4.1708367021908888e-01,-6.4272075336774259e-04,-3.1953280974689871e-02,1.6781682646872430e-02,-4.4949756937567292e-03,};
    ++i; //6 6.333e+00
    reresN16[i] = a_t{-2.1716749876029935e+00,-7.7424662018282069e+00,-4.2422166810836535e+00,-1.2455155295414420e+00,3.6993901665747603e-01,3.7617355995449686e+00,4.9352744635455096e+01,5.4408443085321087e+03,1.7606944481266961e+07,3.3413016835615684e+02,1.7700910059403654e+01,1.8856971173967150e+00,2.7203925939972146e-01,2.1219971155628674e-02,-1.3279878861110163e-02,-9.5508920493694548e-03,};
    imresN16[i] = a_t{2.4588533029052599e+01,-7.4923599339145177e+00,6.7296385781458590e-01,4.2926126154735744e-01,-2.0899227188671923e-01,1.1106889378724123e+00,-1.8257958814488113e+01,-1.3659232341837701e+03,0.0000000000000000e+00,8.9992363138545954e+02,-9.1142973434831038e+00,-1.4518106758365890e-01,2.1462536001516958e-01,-8.6964646428756079e-02,2.4822028570526202e-02,-2.9033197580602349e-03,};
    ++i; //7 7.333e+00
    reresN16[i] = a_t{7.8605245492675007e+00,-6.4887625401142879e-01,-1.2766809818734726e+00,-6.2159379772463552e-01,-1.1694754455788210e+00,-1.0897712964271575e+01,-2.2306891957083829e+02,-9.1886253260665126e+03,7.4389903696980953e+08,7.7651846009157189e+03,9.0295100271370870e+01,4.0392193710097501e+00,1.4961049267366930e-01,-7.8286263785422860e-02,-4.6313134618373671e-02,-1.6290106085964935e-02,};
    imresN16[i] = a_t{1.3509692682004019e+01,-6.1369034626917509e+00,1.6350388432947760e+00,5.2945939085596694e-02,-1.3634842150929707e+00,8.6025292451579709e+00,-1.7985193345826846e+02,6.4917607864525409e+04,0.0000000000000000e+00,3.7000539648182712e+03,3.1917964293412453e+01,-4.7367100232509927e+00,8.6663353641889107e-01,-1.7216194784319749e-01,2.3992079714883464e-02,4.1269833669988886e-03,};
    ++i; //8 8.333e+00
    reresN16[i] = a_t{8.4061564786299492e+00,1.8617661258084155e+00,-6.5289175003130639e-03,-5.2784337554222138e-01,-1.2979399772405287e+00,-3.6575180385416326e+00,-2.7249206899851879e+02,-7.6888528796168335e+05,3.6386004307449890e+10,8.4412546317072338e+04,2.0857138139361973e+02,-2.6017499804014332e+00,-1.4476097215847448e+00,-4.0951947974384928e-01,-1.0515489930061968e-01,-2.0317442090721019e-02,};
    imresN16[i] = a_t{3.1697580090159696e+00,-2.5405575079675868e+00,1.0405425449538921e+00,-9.3477036655207213e-01,5.1215087330885591e+00,-5.6618571070307382e+01,1.7945954322036825e+03,-4.4586288092458114e+05,0.0000000000000000e+00,-2.8911034366662607e+04,4.9080987067915436e+02,-2.3482433448536522e+01,2.0959251267482508e+00,-1.8468692200845171e-01,-1.9481590722533013e-02,2.3230322486576568e-02,};
    ++i; //9 9.333e+00
    reresN16[i] = a_t{4.3866465920857509e+00,1.5413029499638824e+00,7.6351886450243711e-01,2.3877472136712594e+00,1.6606468281354182e+01,2.2935180457425938e+02,1.2217532936813470e+04,1.0815768215324143e+07,2.0221885827841873e+12,4.7027778418766340e+05,-1.4265128169738043e+03,-8.2559132366312994e+01,-8.2268639599527233e+00,-1.1261262879017542e+00,-1.5188572795691901e-01,-3.8051072839557637e-03,};
    imresN16[i] = a_t{-1.7016891685092723e+00,-2.6486635291628424e-01,3.2704482509573862e-01,2.1944626790489766e-01,-7.0653658059238982e+00,1.3243269510971189e+02,-4.7514157128153192e+03,-8.4198544552367758e+06,0.0000000000000000e+00,-9.4066311839963950e+05,3.0592995388986424e+03,-5.9561224855323438e+01,1.3266940639345730e+00,3.9654456630788842e-01,-1.8892541778292893e-01,6.1776416026398606e-02,};
    ++i; //10 1.033e+01
    reresN16[i] = a_t{9.3406954909288409e-01,4.6870251136755314e-01,-3.7667445401768673e-01,-5.1563834408398099e+00,-5.9837977429173691e+01,-1.2391519265221186e+03,-8.2470738309755121e+04,6.5104287548244759e+07,1.2586145337754586e+14,-4.3058505729947044e+06,-2.2938287280074896e+04,-4.7916528127504478e+02,-2.3904502260555685e+01,-1.4964633227060238e+00,4.4200578802613230e-02,8.0981470066303046e-02,};
    imresN16[i] = a_t{-2.1154931150324789e+00,6.5414188816067709e-01,-1.0942548792062867e+00,5.0172202560301757e+00,-3.5787819839106056e+01,6.2916267896827173e+02,-6.7026676545639246e+04,2.2779774627294201e+08,0.0000000000000000e+00,-1.3197692791848155e+07,6.8515201078385453e+03,1.0896800957280756e+02,-1.8892014968661989e+01,3.1934405655068447e+00,-6.0403157516592776e-01,1.0862789570329552e-01,};
    auto v0 = T(1.0/3.0);
    auto h =  eve::half(eve::as(v0));
    using eve::spherical;
    using c_t = kyosu::complex_t<T>;
    std::array<c_t, 5> ks;
    for(int j=0; j <= 15; ++j)
    {
      auto c = kyosu::complex(re[j], im[j]);
      auto iv = kyosu::bessel_k(v0+(N-1), c, std::span(ks));
      TTS_RELATIVE_EQUAL(iv, kyosu::bessel_k(v0+(N-1), c), tts::prec<T>());
      auto fac = kyosu::sqrt(eve::pio_2(eve::as(kyosu::real(c)))*kyosu::rec(c));
      for(int i=0; i < N; ++i)
      {
        auto res = kyosu::complex(reresN16[i][j], imresN16[i][j]);
        auto v = v0+i;
        //       std::cout<< "j " << j  << " c[" << j << "] = " << c << " i " << i << " v " << v << std::endl;
        TTS_RELATIVE_EQUAL(kyosu::bessel_k(v, c), res, tts::prec<T>());
        TTS_RELATIVE_EQUAL(kyosu::bessel_k(-v,c), res, tts::prec<T>());
        TTS_RELATIVE_EQUAL(kyosu::bessel_k[spherical](v, c), kyosu::bessel_k(v+h, c)*fac, tts::prec<T>());
        TTS_RELATIVE_EQUAL(kyosu::bessel_k[spherical](-v, c), kyosu::bessel_k(-v+h, c)*fac, tts::prec<T>());
        if(i < 5)
          if (j!= 8) TTS_RELATIVE_EQUAL(kyosu::bessel_k(v, c), ks[i], tts::prec<T>()) << i << " -- " <<  j <<  " -- "<< c << " v " << v << '\n';
      }
    }
  }
};
